<!DOCTYPE html>
<html lang = "en">
    <head>
        <title>Anon</title>
        <meta name = "viewport" content = "width=device-width, initial-scale=1.0"/>
        <link rel = "stylesheet" href = "/style.css" type = "text/css"/>
        <link rel = "icon" type = "image/x-icon" href = "/favicon.ico"/>
    </head>
    <body>
        <div class = "card" style = "background-color:var(--background)">
            <h1>anon</h1>
            <p style = "color:var(--secondary); margin-bottom:40px;">
                <b>
                    <u>
                        secure by default
                    </u>
                </b>
            </p>
            <div style = "display:flex; align-items:center; justify-content:center;">
                <input id = "message" placeholder = "your messageâ€¦" style = "width:100%; margin-right:10px;" autocomplete = "off"/>
                <button id = "send">
                    Send&nbsp;&nbsp;
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m3 3 3 9-3 9 19-9Z"/><path d="M6 12h16"/></svg>
                </button>
            </div>
            <p style = "color:var(--danger)" id = "error"></p>
            <h3 style = "margin-top:40px">My Feed</h3>
            <div id = "feed"></div>
        </div>
        <script type = "module">
            import { io } from "https://cdn.socket.io/4.7.4/socket.io.esm.min.js"

            function getCookie(cname) {
                let name = `${cname}=`
                let decodedCookie = decodeURIComponent(document.cookie);
                let ca = decodedCookie.split(';');
                for(let i = 0; i <ca.length; i++) {
                    let c = ca[i]
                    while (c.charAt(0) == " ") {
                        c = c.substring(1)
                    }
                    if (c.indexOf(name) == 0) {
                        return c.substring(name.length, c.length)
                    }
                }
                return ""
            }
        
            const socket = io()

            socket.on("msg", (msg) => {
                const msg_component = document.createElement("span")
                msg_component.innerHTML = msg
                document.getElementById("feed").prepend(msg_component)
            })

            socket.on("user-connection", (arg) => {
                const p = document.createElement("p")
                p.innerHTML = `<span style = "color:var(--${arg == "a user has connected" ? "success" : "danger"})">${arg}</span>`
                document.getElementById("feed").appendChild(p)
            })

            document.getElementById("send").addEventListener("click", send_message)
            function send_message(){
                if(document.getElementById("message").value == ""){
                    document.getElementById("error").innerText = "Please write a message first!"
                }else if(getCookie("alias") == ""){
                    window.location.href = "/"
                }else{
                    document.getElementById("error").innerText = ""
                    socket.emit("msg", `<div class = "message">${getCookie("alias")}: <span>${document.getElementById("message").value}</span></div>`)
                    document.getElementById("message").value = ""
                }
            }
        </script>
    </body>
</html>